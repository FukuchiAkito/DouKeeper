# 要件定義書 - DouKeeper（頒布部数管理アプリ）

## 1. 文書の目的
- DouKeeper MVPに必要な機能要件・非機能要件・外部制約を定義し、フロントエンドとバックエンドで共有する
- 将来的な拡張要望（ロードマップ）を明示し、MVPとの境界を明確にする
- AWS（Amplify / Cognito / DynamoDB）を採用した際の前提条件を整理する

## 2. プロダクト概要
- 同人誌・グッズ等の頒布物の在庫と販売実績をイベント当日に即座に把握できるWebアプリ
- ブラウザ（PC / スマートフォン）で利用し、将来的にReact Nativeでのモバイル展開も視野に入れる

## 3. 想定ユーザーとペルソナ
- 個人または小規模サークルの主宰者
- 1イベントで扱う作品は数点〜十数点、リアルタイムに在庫を把握したい
- 在庫管理ツールに慣れておらず、数タップで操作できるUIを求める

### ペルソナ例
- 名前：佐藤 円香（20代後半、同人誌サークル主宰）
- 課題：イベント中に紙のメモで在庫管理しているが、忙しいと数え間違いが発生する
- 期待：在庫を登録しておけば、頒布が発生したタイミングで即座に残数を確認できる

## 4. 用語定義
- 作品：頒布対象の同人誌またはグッズ
- 頒布記録：特定の作品が指定部数だけ頒布された履歴
- イベント：即売会やオンライン頒布会などの開催情報
- ユーザー：DouKeeperへサインインする個別のサークル利用者

## 5. スコープ
### MVP（現在の開発対象）
- 作品登録・編集・削除
- 在庫数の追跡（初期在庫／現在庫）と頒布登録による自動減算
- 頒布履歴の記録・削除
- イベント情報の登録・削除
- Cognitoを利用したユーザー認証（メール + パスワード）
- DynamoDBへのデータ永続化、Amplify Hostingでの公開

### 将来拡張（参考）
- イベント別集計、売上グラフ
- QRコードによる作品登録
- マルチデバイス同期（複数ユーザーによる同時操作）
- ダークモード、React Nativeアプリ
- CSVエクスポート

## 6. 機能要件
### 6.1 作品管理
- 作品を登録する際、タイトル・初期在庫・（任意）単価・メモを入力する
- 作品の編集はタイトル・在庫数・単価・メモを更新できる
- 作品削除時は関連する頒布記録も同時に削除する

### 6.2 頒布管理
- 指定した作品の頒布数を登録すると、現在庫が自動的に減算される
- 在庫不足の場合は在庫数以下に丸めて登録し、ユーザーへ通知する
- 頒布記録には日付時刻、イベント名（任意）、メモ（任意）を保存できる
- 頒布履歴を削除すると在庫が元に戻る

### 6.3 在庫補充
- 作品ごとに補充数を登録できる
- 補充時は現在庫と初期在庫の両方に加算する

### 6.4 イベント管理
- イベント名・開催日・会場（任意）・メモ（任意）を登録できる
- イベント削除は頒布履歴に影響を与えない

### 6.5 認証・ユーザー管理
- Cognito User Poolでメールアドレス／パスワード認証
- パスワードリセット、メール検証フローを利用できる
- 各ユーザーが自分のデータのみにアクセスできるマルチテナント設計

### 6.6 監査・ログ
- 重要操作（作品作成・頒布登録・削除など）をCloudWatch Logsへ記録する

## 7. API要件（MVP）
- Amplify Function（AWS Lambda）+ API Gateway構成でREST APIを提供
- エンドポイント例
  - `POST /works`：作品登録
  - `GET /works`：作品一覧取得
  - `PATCH /works/{id}`：作品更新
  - `DELETE /works/{id}`：作品削除（頒布記録も削除）
  - `POST /distributions`：頒布記録登録
  - `GET /distributions?workId=`：作品別履歴取得
  - `DELETE /distributions/{id}`：頒布記録削除
  - `POST /restocks`：在庫補充記録（将来の集計に備えて履歴化）
  - `GET /events` / `POST /events` / `DELETE /events/{id}`
- すべてのAPIはCognito JWTを検証し、`sub`（ユーザーID）でデータをスコープする

## 8. データ要件
### 8.1 DynamoDBテーブル設計
- `Works` テーブル
  - パーティションキー：`userId`, ソートキー：`workId`
  - 属性：`title`, `initialStock`, `currentStock`, `price`, `memo`, `createdAt`, `updatedAt`
- `DistributionRecords` テーブル
  - PK：`userId`, SK：`recordId`
  - GSI：`workId-index`（PK: `workId`, SK: `distributedAt`）
- `Events` テーブル
  - PK：`userId`, SK：`eventId`
  - 属性：`name`, `date`, `location`, `memo`, `createdAt`
- 数値は常に非負整数に正規化、日時はISO8601文字列で保存

### 8.2 データ保持・整合性
- 作品削除時に関連頒布記録をバッチ削除する（GSIで抽出）
- 頒布記録削除時はトランザクションで在庫数を更新
- データ保持期間：ユーザーが削除するまで無期限（将来的なバックアップ要件は別途検討）

## 9. 非機能要件
- パフォーマンス：通常操作（作品一覧取得等）は500ms以内、ピーク時でも1秒以内
- 可用性：Amplify Hosting / API Gateway / DynamoDBを利用し、SLA 99.9%を目標
- セキュリティ：
  - Cognitoによる認証、IAMポリシーでユーザーデータへのアクセスを制限
  - DynamoDBの暗号化（既定）利用、CloudWatchログのマスキング
  - OWASP Top 10に対する静的解析（ESLint、npm audit）
- ログ・監査：監査ログは90日保持、CloudWatchメトリクスをAmplify Monitoringに送信
- スケーラビリティ：ユーザー毎にデータ分離されるため、サークル数増加にも対応可能

## 10. 開発・運用体制
- リポジトリ：GitHub（main/devブランチ運用）
- CI/CD：Amplify Hostingのブランチ連携
- コード品質：ESLint / Prettier / TypeScript strict mode
- テスト：Jest + React Testing Library（フロント）、Amplify Function用にVitest or Jest
- Issueトラッキング：GitHub Projects

## 11. 成功指標（例）
- イベント当日の在庫数確認にかかる時間が紙管理比で50%以上短縮
- イベント終了直後に在庫数の誤差が±1部以内
- 月間アクティブユーザー（MAU）：β版で50サークル、正式版で200サークル

## 12. リスクと前提
- ネットワーク接続が不安定な会場を想定し、短時間のオフライン時はフロントのローカルストアに退避（バックエンド連携時に差分同期を行う）
- AWSアカウントとAmplifyプロジェクトは既に準備済みであることを前提
- Cognitoのメール送信にはSESなどの設定が必要
- データ増加に伴うDynamoDBコスト増を定期的にモニタリングする
