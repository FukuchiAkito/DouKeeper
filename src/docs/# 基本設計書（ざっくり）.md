# 基本設計書（ざっくり） - DouKeeper

## 1. システム概要
DouKeeperは、同人誌・グッズの在庫と頒布履歴を簡潔に管理するWebアプリケーション。フロントエンドはNext.js（App Router）で構築し、AWS Amplifyを用いたServerlessアーキテクチャでバックエンド/API/認証基盤を提供する。

## 2. アーキテクチャ構成
- **フロントエンド**：Next.js 15 + React 19 + TypeScript。
  - UI設計はAtomic Designを採用（atoms/molecules/organisms/templates）。
  - Zustand + `persist`でフロント上の一時状態を管理し、バックエンド同期後との整合性を保つ。
- **バックエンド/API**：Amplify Function（Node.js Lambda）+ API GatewayのREST API。
  - 作品・頒布・イベントそれぞれのCRUDを提供し、DynamoDBへの永続化を行う。
  - 入力バリデーションはzod（またはJoi）で実装し、レスポンスは統一フォーマット `{ data, error }` を返す。
- **データベース**：DynamoDB（ユーザー単位のパーティション分割）。
- **認証**：AWS Cognito User Pool（メール＋パスワード）。
  - Amplify Hosted UIを利用せず、Next.js側でサインインフォームを実装し、CognitoのAuthentication APIを呼び出す。
- **ホスティング**：Amplify HostingでNext.jsアプリをSSR対応でデプロイ。バックエンドLambdaは同一Amplifyアプリ内またはSST等で管理。

## 3. 構成イメージ
```
[ユーザー] --HTTPS--> [Amplify Hosting (Next.js)]
                         |  \--fetch--> [API Gateway] --> [Lambda Functions] --> [DynamoDB]
                         \--Cognito Hosted UI / Auth API
```

## 4. データモデル
| エンティティ | 主な属性 | 備考 |
| --- | --- | --- |
| Work | workId, userId, title, initialStock, currentStock, price, memo, createdAt, updatedAt | `userId + workId`でPK。`initialStock`と`currentStock`は非負整数 |
| DistributionRecord | recordId, userId, workId, quantity, eventId?, eventName?, memo?, distributedAt, createdAt | GSI `workId-index` (PK: workId, SK: distributedAt)。在庫整合性計算に利用 |
| Event | eventId, userId, name, date, location?, memo?, createdAt | イベント削除時も履歴は保持（eventNameを履歴に冗長保存） |
| RestockRecord（将来） | restockId, userId, workId, quantity, memo?, restockedAt | 補充履歴を残す場合に追加 |

数値型はDynamoDBのNumber型、日時はISO8601文字列（UTC）で保存。Lambda内で正規化。

## 5. API設計（MVP）
| メソッド | パス | 用途 | 認可 | バリデーション |
| --- | --- | --- | --- | --- |
| POST | /works | 作品登録 | Cognito JWT必須 | title（1〜120文字）、初期在庫>=0 |
| GET | /works | 作品一覧取得 | 同上 | クエリ無し（ユーザー単位で絞る） |
| PATCH | /works/{id} | 作品更新 | 同上 | body内のオプション項目を部分更新 |
| DELETE | /works/{id} | 作品削除 | 同上 | 削除トランザクション（頒布記録も削除） |
| POST | /distributions | 頒布登録 | 同上 | workId必須、quantity>=1、在庫ロックをDynamoDBトランザクションで実施 |
| GET | /distributions | 頒布履歴一覧 | 同上 | クエリ`workId`（必須）と`limit`/`lastKey` |
| DELETE | /distributions/{id} | 頒布履歴削除 | 同上 | 在庫巻き戻しトランザクション |
| POST | /events | イベント登録 | 同上 | name必須、dateは未来/過去問わず許容 |
| GET | /events | イベント一覧 | 同上 | 並び順：date昇順 |
| DELETE | /events/{id} | イベント削除 | 同上 | 単純削除 |

レスポンスは`{ data: ..., error: null }` もしくは `{ data: null, error: { code, message } }`。

## 6. バックエンドロジック
1. **認証処理**：API GatewayでCognito Authorizerを設定し、デコード済みJWTをLambdaに渡す。
2. **入力検証**：Lambda内でzodスキーマによりチェック。エラー時はHTTP 400 + エラーコード。
3. **在庫整合性**：頒布登録・削除はDynamoDBのTransactWriteItemsで在庫数と履歴を同時更新。条件式で負在庫を防止。
4. **監査ログ**：Lambdaで重要操作をCloudWatch Logsに構造化JSONで出力。`userId`、操作種別、対象ID、結果を記録。
5. **エラーハンドリング**：Amplify Function共通の`errorHandler`ユーティリティを用意し、エラーコードをフロントと共有。

## 7. フロントエンド設計
- **ルーティング**：App Routerの`/`にダッシュボード＋管理画面を集約。将来的に`/login`や`/events`などのページを追加。
- **状態管理**：
  - UIローカル状態：Zustand（`useStore`）。
  - サーバー同期：React Queryなどの導入を検討し、APIレスポンスをキャッシュ & 楽観的更新。
- **UIフロー**：
  1. 作品登録フォーム（WorkForm）
  2. 作品カードで頒布登録・補充・削除
  3. 頒布履歴リスト
  4. イベント管理フォーム
- **バリデーション**：フロント側はReact Hook Form + zodを採用予定（現状は手書きバリデーション）。
- **アクセシビリティ**：フィードバックメッセージをARIA Liveに対応させ、キーボード操作可能なボタン/フォーム構成にする。

## 8. 認証・認可
- サインイン後にCognito IDトークンを保管（Secure HttpOnly Cookie推奨）。
- API呼び出し時は`Authorization: Bearer <token>`を付与。
- フロント側ではAmplify Authまたはamazon-cognito-identity-jsを利用してトークンリフレッシュを行う。
- 今後のマルチテナント拡張に備え、Cognitoグループやカスタム属性でロール管理を実装可能な構造にする。

## 9. インフラ設計
- **環境分離**：dev / staging / prod のAmplify環境を用意。ブランチ毎に自動デプロイ。
- **秘密情報**：環境変数（DynamoDBテーブル名、Cognito情報）はAmplify Secrets Managerに保存。
- **モニタリング**：CloudWatchメトリクス + Amplify Monitoring。閾値アラート（トランザクション失敗、4xx/5xx急増）を設定。
- **コスト管理**：DynamoDBはオンデマンドキャパシティ、利用状況に応じてAutoscalingを検討。

## 10. テスト方針
- フロント：React Testing Libraryでコンポーネントテスト、PlaywrightでE2E（作品登録〜頒布まで）。
- バックエンド：Lambda単体テスト（Vitest/Jest）、DynamoDB Local＋Amplify Mockで統合テスト。
- CI：GitHub Actions（またはAmplify CI）でLint -> Unit Test -> Build -> デプロイを実行。

## 11. データ移行・バックアップ
- 現行ローカルストレージデータからの移行は、ユーザーが初回ログイン時にCSVインポートできる仕組みを将来提供。
- DynamoDBのPoint-in-Time Recovery (PITR) を有効化し、最大35日分を復元可能にする。

## 12. 今後の検討事項
- 楽観的更新とオフライン対応：フロントで操作履歴キューを持ち、オンライン復帰時に同期。
- 作品・イベントのタグ分類、検索機能。
- BIツール連携（QuickSight 等）による売上可視化。
- セキュリティレビュー（IAMポリシー最小権限、Cognitoパスワードポリシー強化）。
